name: mcp-toolset

services:
  diagramclean:
    container_name: clai-diagramclean
    image: alpine:3.20
    working_dir: /workspace
    volumes:
      - .:/workspace
    command:
      [
        "sh",
        "-ceu",
        "rm -rf /workspace/.generated-docs /workspace/mermaid; mkdir -p /workspace/.generated-docs"
      ]
    restart: "no"

  diagramgen:
    container_name: clai-diagramgen
    image: structurizr/cli
    working_dir: /workspace
    volumes:
      - .:/workspace
    command:
      [
        "export",
        "-workspace",
        "/workspace/workspace.dsl",
        "-format",
        "mermaid",
        "-output",
        "/workspace/.generated-docs"
      ]
    restart: "no"
    depends_on:
      diagramclean:
        condition: service_completed_successfully

  diagramsync:
    container_name: clai-diagramsync
    image: python:3.12-alpine
    working_dir: /workspace
    volumes:
      - .:/workspace
    command:
      [
        "sh",
        "-ceu",
        "python - <<'PY'\nfrom pathlib import Path\n\ntmp_dir = Path('/workspace/.generated-docs')\nmmd_path = tmp_dir / 'structurizr-main-overview.mmd'\nmmd = mmd_path.read_text(encoding='utf-8').rstrip()\nblock = f\"<!-- BEGIN:STRUCTURIZR_MAIN_OVERVIEW -->\\n```mermaid\\n{mmd}\\n```\\n<!-- END:STRUCTURIZR_MAIN_OVERVIEW -->\"\nfor doc in (Path('/workspace/README.md'), Path('/workspace/AGENTS.md')):\n    text = doc.read_text(encoding='utf-8')\n    start = '<!-- BEGIN:STRUCTURIZR_MAIN_OVERVIEW -->'\n    end = '<!-- END:STRUCTURIZR_MAIN_OVERVIEW -->'\n    i = text.find(start)\n    j = text.find(end)\n    if i == -1 or j == -1:\n        raise SystemExit(f'missing sync markers in {doc}')\n    j += len(end)\n    doc.write_text(text[:i] + block + text[j:], encoding='utf-8')\nfor p in tmp_dir.glob('*'):\n    if p.is_file():\n        p.unlink(missing_ok=True)\ntmp_dir.rmdir()\nPY"
      ]
    restart: "no"
    depends_on:
      diagramgen:
        condition: service_completed_successfully

  flakegen:
    container_name: clai-flakegen
    image: python:3.12-alpine
    working_dir: /workspace/server
    environment:
      NIXPKGS_URL: ${NIXPKGS_URL:-github:NixOS/nixpkgs/nixos-24.11}
      NIX_SYSTEM: ${NIX_SYSTEM:-x86_64-linux}
    volumes:
      - .:/workspace
    command:
      [
        "sh",
        "-ceu",
        "python -m pip install pyyaml --quiet --no-cache-dir --disable-pip-version-check --root-user-action=ignore >/dev/null; exec python -m tool_mounting.flakegen"
      ]
    restart: "no"
    depends_on:
      diagramsync:
        condition: service_completed_successfully

  clai:
    container_name: clai
    image: ghcr.io/nixos/nix:latest
    working_dir: /workspace/server
    entrypoint:
      [
        "nix",
        "shell",
        "--no-write-lock-file",
        "path:/workspace/server#cli",
        "-c",
        "sh",
        "-ceu",
        "python -m pip install mcp pyyaml --target /tmp/mcp-py --upgrade --no-cache-dir --disable-pip-version-check --root-user-action=ignore >/dev/null; export PYTHONPATH=\"/tmp/mcp-py:$${PYTHONPATH:-}\"; exec \"$@\"",
        "sh"
      ]
    command:
      [
        "python",
        "-c",
        "from bootstrap import main; raise SystemExit(main())"
      ]
    environment:
      MCP_SERVER_URL: ${MCP_SERVER_URL:-http://clai:8000/mcp}
      NIX_CONFIG: |-
        experimental-features = nix-command flakes
        warn-dirty = false
        build-users-group =
    volumes:
      - nix_store:/nix
      - .:/workspace:ro
    ports:
      - "${FASTMCP_HOST_PORT:-8000}:8000"
    restart: unless-stopped
    logging:
      driver: json-file
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      flakegen:
        condition: service_completed_successfully

  acceptance:
    container_name: clai-acceptance
    image: python:3.12-alpine
    working_dir: /workspace
    volumes:
      - .:/workspace:ro
    environment:
      MCP_SERVER_URL: ${MCP_SERVER_URL:-http://clai:8000/mcp}
      MCP_PROTOCOL_VERSION: ${MCP_PROTOCOL_VERSION:-2025-06-18}
    command:
      [
        "sh",
        "-ceu",
        "python -m pip install pyyaml --quiet --no-cache-dir --disable-pip-version-check --root-user-action=ignore >/dev/null; python -m unittest discover -s tests -p \"acceptance_tests.py\" -v"
      ]
    restart: "no"
    depends_on:
      clai:
        condition: service_started

volumes:
  nix_store:

